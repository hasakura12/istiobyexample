<!doctype html><html><head><meta charset=utf-8><title>仮想マシン&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=https://istiobyexample-ja.github.io/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="仮想マシン"><meta property="og:description" content="Kubernetesでコンテナ化されたサービスを実行すると、自動スケーリング、依存関係の分離、リソースの最適化など、多くのメリットが得られま"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/virtual-machines/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-05T18:13:22+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="仮想マシン"><meta name=twitter:description content="Kubernetesでコンテナ化されたサービスを実行すると、自動スケーリング、依存関係の分離、リソースの最適化など、多くのメリットが得られま"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> の和訳です</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>仮想マシン</h1></section><div class=flex-body><article class=markdown-body><p>Kubernetesでコンテナ化されたサービスを実行すると、自動スケーリング、依存関係の分離、リソースの最適化など、多くのメリットが得られます。 IstioをKubernetes環境に追加すると、多数のコンテナーを操作している場合でも、メトリクスの集計とポリシー管理を大幅に簡略化できます。</p><p>しかし、ステートフルサービス、またはレガシーアプリケーションが仮想マシンで実行されている場合はどうでしょうか。または、VMからコンテナーに移行する場合はどうでしょうか？心配要りません。仮想マシンをIstioサービスメッシュに統合できます。方法を見てみましょう。</p><p><a target=_blank rel="noopener noreferrer" href=../images/vm-call-flow.png><img class=img src=../images/vm-call-flow.png alt></a></p><p>この例では、地方図書館のWebアプリケーションを実行しています。このウェブアプリには複数のバックエンドがあり、すべてKubernetesクラスターで実行されています。 Kubernetesのワークロードの1つ、<code>inventory</code> は、PostgreSQLデータベースと通信し、図書館に追加された新しい本ごとにレコードを書き込みます。このデータベースは、別のクラウドリージョンの仮想マシンで実行されています。</p><p>VMベースのデータベースであるPostgreSQLの完全なIstioの機能を取得するには、VMにIstioサイドカープロキシをインストールし、クラスターで実行されているIstioコントロールプレーンと通信するように構成する必要があります。（これは外部の<a href=../external-services>ServiceEntries</a>を追加するのとは異なる点に注意してください。）Postgresデータベースを3つのステップでメッシュに追加できます。<a href=https://github.com/askmeegs/postgres-library/tree/0241acce9d7e2cede0de8ac9baa1338624f716eb#-postgres-library target=_blank>GitHubのデモコマンド</a>に従ってください。</p><p><a target=_blank rel="noopener noreferrer" href=../images/vm-architecture.png><img class=img src=../images/vm-architecture.png alt></a></p><ol><li><strong>PodからVMへのトラフィック用の<a href=https://github.com/askmeegs/postgres-library#5-allow-pod-ip-traffic-to-the-vm target=_blank>ファイアウォールルールを作成</a>します。</strong> これにより、Kubernetes PodのCIDR範囲からVMベースのワークロードに直接トラフィックを送信できます。</li><li><strong>VM上に<a href=https://github.com/askmeegs/postgres-library#6-prepare-a-clusterenv-file-to-send-to-the-vm target=_blank>Istioをインストール</a>します。</strong> サービスアカウントキー、およびVMサービスが公開するポート（この場合は、PostgreSQLクライアントポート <code>5432</code>）をコピーします。 VMの <code>/etc/hosts</code> を更新して、クラスターで実行されているIstio IngressGatewayを介して <code>istio.pilot</code> および <code>istio.citadel</code> トラフィックをルーティングします。次に、VMにIstioサイドカープロキシとノードエージェントをインストールします。ノードエージェントは、相互TLS認証のために、サイドカープロキシにマウントするクライアント証明書を生成します。<code>systemctl</code> を使用してプロキシとノードエージェントを起動します。</li><li><strong>Kubernetesのワークロード<a href=https://github.com/askmeegs/postgres-library#8-register-the-vm-with-istio-running-on-the-gke-cluster target=_blank>VMに登録</a>します。</strong> Postgresデータベースをメッシュに追加するには、2つのKubernetesリソースが必要です。 1つは <code>ServiceEntry</code>です。これにより、KubernetesのDNS名で仮想マシンのIPアドレスにルーティング可能になります。最後に、そのDNSエントリを作成するには、Kubernetesの <code>Service</code> が必要です。これにより、クライアントPodが <code>postgres-1-vm.default.svc.cluster.local</code> で<a href=https://github.com/askmeegs/postgres-library/blob/master/main.go#L39 target=_blank>データベース接続を開始</a>できるようになります。これを行うには、<code>istioctl register</code> コマンドを使用できます。</li></ol><p>Podのログを見ることで、Kubernetesベースのクライアントがデータベースに正常に書き込めることを確認できます。:</p><pre><code>postgres-library-6bb956f86b-dt94x server ✅ inserted Fun Home
postgres-library-6bb956f86b-dt94x server ✅ inserted Infinite Jest
postgres-library-6bb956f86b-dt94x server ✅ inserted To the Lighthouse
</code></pre><p>また、VM上にあるEnvoyのアクセスログを見ることで、VM上で実行されているサイドカープロキシがポート <code>5432</code> で内向きのトラフィックを傍受していることを確認できます。</p><pre><code>$ tail /var/log/istio/istio.log

[2019-11-14T19:09:00.174Z] &quot;- - -&quot; 0 - &quot;-&quot; &quot;-&quot; 268 441 194 - &quot;-&quot; &quot;-&quot; &quot;-&quot; &quot;-&quot;
&quot;127.0.0.1:5432&quot; inbound|5432|tcp|postgresql-1-vm.default.svc.cluster.local
127.0.0.1:54104 10.128.0.14:5432 10.24.2.23:40190
outbound_.5432_._.postgresql-1-vm.default.svc.cluster.local -
</code></pre><p>KialiサービスグラフでTCPメトリックフローを確認することもできます。:</p><p><a target=_blank rel="noopener noreferrer" href=../images/vm-kiali.png><img class=img src=../images/vm-kiali.png alt></a></p><p>ここから、マルチ環境のサービスメッシュで、すべてのIstioトラフィックやセキュリティポリシーを使用できます。たとえば、メッシュ全体の相互TLSポリシーを追加することで、クラスターとVM間のすべてのトラフィックを暗号化できます。:</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;authentication.istio.io/v1alpha1&#34;</span><span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;MeshPolicy&#34;</span><span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default&#34;</span><span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>peers</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>mtls</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;networking.istio.io/v1alpha3&#34;</span><span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;DestinationRule&#34;</span><span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>namespace</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;istio-system&#34;</span><span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.local&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>trafficPolicy</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>tls</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>mode</span><span class=p>:</span><span class=w> </span>ISTIO_MUTUAL<span class=w>
</span></code></pre></div><p>より詳しく学ぶ:</p><ul><li><a href=https://github.com/askmeegs/postgres-library target=_blank>ご自身の環境でこの例を動かしてみましょう</a></li><li><a href=https://github.com/GoogleCloudPlatform/istio-samples/tree/master/mesh-expansion-gce target=_blank>別のサンプル例</a></li><li><a href=https://istio.io/docs/examples/virtual-machines/single-network/ target=_blank>Istioのドキュメントをご覧ください</a></li></ul></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>