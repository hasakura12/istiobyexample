<!doctype html><html><head><meta charset=utf-8><title>認可&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=../istiobyexample/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="認可"><meta property="og:description" content="認証とは、クライアントの身元を確認することです。一方、認可では、そのクライアントのアクセス権限を確認します。すなわち、「このサービスは、クラ"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/authorization/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-05T18:10:01+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="認可"><meta name=twitter:description content="認証とは、クライアントの身元を確認することです。一方、認可では、そのクライアントのアクセス権限を確認します。すなわち、「このサービスは、クラ"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> を和訳したものです</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>認可</h1></section><div class=flex-body><article class=markdown-body><p>認証とは、クライアントの身元を確認することです。一方、<strong>認可</strong>では、そのクライアントのアクセス権限を確認します。すなわち、「このサービスは、クライアントの要求を実行可能かどうか？」を確認します。</p><p>Istioメッシュのすべてのリクエストはデフォルトで許可されていますが、ワークロードのきめ細かなポリシーを定義できる<a href=https://istio.io/docs/reference/config/security/authorization-policy/ target=_blank><code>AuthorizationPolicy</code> resource</a>を<a href=https://istio.io/docs/concepts/security/#authorization target=_blank>Istioは提供</a>します。 IstioはAuthorizationPoliciesをEnvoyで読み取り可能な構成に変換し、その構成をIstioサイドカープロキシにマウントします。そこから、認可ポリシーチェックがサイドカープロキシによって実行されます。それがどのように機能するか見てみましょう。</p><p><a target=_blank rel="noopener noreferrer" href=../images/rbac.png><img class=img src=../images/rbac.png alt="shoes rbac"></a></p><p>ここでは、ShoeStoreアプリケーションが Kubernetesの <code>default</code> Namespaceにデプロイされています。3つのHTTPワークロードがあり、それぞれ独自のKubernetes Deployment、Service、ServiceAccountで定義されています。</p><ol><li><strong>shoes</strong>：ストア内のすべての靴のAPIを公開</li><li><strong>users</strong>：ストアの購入履歴</li><li><strong>inventory</strong>：新しい靴モデルをshoesにロードします。</li></ol><p>inventoryサービスがshoesサービス にデータを <code>POST</code> できるように認可し、usersサービスへのすべてのアクセスをロックします。これを行うには、<code>shoes</code> 用と <code>users</code> 用の2つの <code>AuthorizationPolicies</code> を作成します。</p><p>ポリシーをデプロイする前は、inventoryサービスのアプリケーションコンテナー内からshoesとusersの両方にアクセスできます。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl -X GET shoes
🥾 Shoes service
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl -x GET users
👥 Users service
</code></pre></div><p>まず、<code>shoes</code> 用のAuthorizationPolicyを作成します。：</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;security.istio.io/v1beta1&#34;</span><span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;AuthorizationPolicy&#34;</span><span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;shoes-writer&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>namespace</span><span class=p>:</span><span class=w> </span>default<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>app</span><span class=p>:</span><span class=w> </span>shoes<span class=w>
</span><span class=w>  </span><span class=k>rules</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>from</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>source</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>principals</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;cluster.local/ns/default/sa/inventory-sa&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=k>to</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>operation</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>methods</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;POST&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></div><p>このポリシーでは：</p><ul><li><code>shoes</code> の <code>selector</code> は、<code>app：shoes</code> というラベルの付いたDeploymentに適用されることを意味します。</li><li>私たちが許可している <code>source</code> ワークロードには、<code>inventory-sa</code> IDがあります。これは、Kubernetes環境では、<code>inventory-sa</code> <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/ target=_blank>サービスアカウント</a>を持つPodのみがshoesにアクセスできることを意味します。（<strong>注</strong>：サービスアカウントベースの認可ポリシーを使用するには、<a href=https://istio.io/docs/tasks/security/authentication/authn-policy/#globally-enabling-istio-mutual-tls target=_blank>Istio相互TLS認証</a>を有効にする必要があります。相互TLSにより、ワークロードの<a href=https://istio.io/docs/concepts/security/#istio-security-vs-spiffe target=_blank>サービスアカウント</a>証明書をリクエストで渡すことができます。）</li><li>ホワイトリストに登録されている唯一のHTTP操作は <code>POST</code> です。つまり、<code>GET</code> などの他のHTTP操作は拒否されます。</li></ul><p><code>shoes-writer</code> のポリシーを適用したら、inventoryから <code>POST</code> することができます。</p><pre><code>$ curl -X POST shoes
🥾 Shoes service
</code></pre><p>ただし、<code>inventory</code> からの <code>GET</code> リクエストは拒否されます。:</p><pre><code>$ curl -X GET shoes
RBAC: access denied
</code></pre><p>また、<code>users</code> など、<code>inventory</code> 以外のワークロードから <code>POST</code> しようとすると、リクエストが拒否されます。:</p><pre><code>$ curl -X POST shoes
RBAC: access denied
</code></pre><p>次に、usersサービスの「deny-all」ポリシーを作成します。：</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;security.istio.io/v1beta1&#34;</span><span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;AuthorizationPolicy&#34;</span><span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;users-deny-all&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>namespace</span><span class=p>:</span><span class=w> </span>default<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>app</span><span class=p>:</span><span class=w> </span>users<span class=w>
</span></code></pre></div><p>このサービスには <code>rules</code> がないことに注意してください。users Deploymentの <code>matchLabels</code> のみです。また、deny-allとallow-all AuthorizationPolicyの<a href=https://istio.io/docs/concepts/security/#allow-all-and-deny-all target=_blank>違い</a>はわずかであることに注意してください。allow-allポリシーでは、<code>rules: {}</code> を指定します。</p><p>このリソースを適用すると、どのサービスからもusersにアクセスできなくなります。：</p><pre><code>$ curl users
RBAC: access denied
</code></pre><p>詳しく学ぶ:</p><ul><li><a href=https://github.com/askmeegs/istiobyexample/tree/master/yaml/authorization target=_blank>この例のマニフェストファイル</a></li><li><a href=https://istio.io/blog/2019/v1beta1-authorization-policy/ target=_blank>Istio ブログ - Istio v1beta1認可ポリシーの紹介</a></li><li><a href=https://istio.io/docs/concepts/security/#authorization target=_blank>Istio docs - 認可の概念</a></li><li><a href=https://istio.io/docs/tasks/security/authorization/authz-http/ target=_blank>Istio docs - 認可タスク</a></li><li><a href=https://github.com/GoogleCloudPlatform/istio-samples/tree/6fa69cf46424c055535ddbdc22f715e866c4d179/security-intro#demo-introduction-to-istio-security target=_blank>Istio サンプル - Istioセキュリティの概要</a></li></ul></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>