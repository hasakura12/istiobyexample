<!doctype html><html><head><meta charset=utf-8><title>フォールトインジェクション&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=../istiobyexample/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="フォールトインジェクション"><meta property="og:description" content="マイクロサービスを採用すると、多くの場合、依存関係が増え、制御できないサービスが増えます。また、ネットワーク上のリクエストが増えるため、エラ"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/fault-injection/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-10T10:04:14+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="フォールトインジェクション"><meta name=twitter:description content="マイクロサービスを採用すると、多くの場合、依存関係が増え、制御できないサービスが増えます。また、ネットワーク上のリクエストが増えるため、エラ"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> を和訳したものです</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>フォールトインジェクション</h1></section><div class=flex-body><article class=markdown-body><p>マイクロサービスを採用すると、多くの場合、依存関係が増え、制御できないサービスが増えます。また、ネットワーク上のリクエストが増えるため、エラーが発生する可能性が高くなります。これらの理由により、アップストリームの依存関係が失敗したときのサービスにおける動作をテストすることが重要です。</p><p><strong><a href=https://en.wikipedia.org/wiki/Chaos_engineering target=_blank>カオステスト</a></strong> は、弱点を明らかにし、フォールトトレランスを向上させるために、サービスを意図的に壊すプロセスです。カオステストでは、エラーを返す代わりに、クライアント側のバグを明らかにしたり、エラーを返すのではなくキャッシュされた結果を表示したいと思うようなユーザーが直面する問題の状況を特定したりすることができます。</p><p>Kubernetes環境では、<a href=https://github.com/asobti/kube-monkey#kube-monkey-- target=_blank>Podをランダムに削除</a>したり、ノード全体をシャットダウンしたりするなど、さまざまなレイヤーでのカオステストに取り組むことができます。</p><p>ただし、障害はアプリケーション層でも発生します。無限ループ、壊れたクライアントライブラリ-アプリケーションコードは無限に失敗する可能性があります！ここで Istio <strong><a href=https://istio.io/docs/concepts/traffic-management/#fault-injection target=_blank>fault injection</a></strong> の出番です。Istio VirtualServicesを使用して、実際にアプリのコードを更新せずに、タイムアウトまたはHTTPエラーをサービスに起こすことにより、アプリケーションレイヤーでカオステストを実行できます。方法を見てみましょう。</p><p><a target=_blank rel="noopener noreferrer" href=../images/fault-injection.png><img class=img src=../images/fault-injection.png alt></a></p><p>この例では、風力エネルギー会社が2つのKubernetesクラスターを実行しています。1つはクラウド内、もう1つはオフショアの風力発電所内です。これら2つのクラスターは、<a href=https://istio.io/docs/setup/install/multicluster/shared-gateways/ target=_blank>単一のコントロールプレーンのマルチクラスタ構成のIstio</a>を使用して相互に接続されて、クラウド側クラスターで実行されます（<em>注</em>-この例は、単一クラスターセットアップでも機能します）。 3つのサービスがあります。<code>ingest</code> は、タービンからのセンサーデータを処理し、オンプレミスの時系列データベースに書き込みます。<code>insights</code> は発電機の異常検出のためにデータベースをポーリングし，電力系統への潜在的な驚異がある場合，クラウドで稼働する <code>alerts</code> にメッセージを送信します。</p><p>insights サービスが <code>alerts</code> のホームを呼び出せない場合、異常が失われないようにする必要があります。理想的には、insights がアラートをキャッシュするか、Istioの<a href=../retry>リトライロジック</a>を使用してリクエストを再送信します。この障害シナリオで何が発生するかをテストするために、Istioを使用して <code>alerts</code> サービスに障害を起こします。最初に5秒の遅延を追加し、次に <code>500 - Internal Server Error</code> を追加します。:</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>alerts-fault<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- alerts<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>fault</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>abort</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>httpStatus</span><span class=p>:</span><span class=w> </span><span class=m>500</span><span class=w>
</span><span class=w>        </span><span class=k>percentage</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span><span class=k>value</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>      </span><span class=k>delay</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>percentage</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span><span class=k>value</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>        </span><span class=k>fixedDelay</span><span class=p>:</span><span class=w> </span>5s<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>alerts<span class=w>
</span></code></pre></div><p>このVirtualServiceを適用し、<code>insights</code> アプリケーションコンテナーから <code>alerts</code> に curl でアクセスすると、構成されたタイムアウトに続いて500エラーが表示されます。:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl -v alerts.default.svc.cluster.local:80/

...
* Connected to alerts.default.svc.cluster.local <span class=o>(</span>10.12.10.16<span class=o>)</span> port <span class=m>80</span> <span class=o>(</span><span class=c1>#0)</span>

&lt; HTTP/1.1 <span class=m>500</span> Internal Server Error
...
fault filter abort
</code></pre></div><p>そして、<code>insights</code> ログを調べて、クライアント側がその失敗をどのように処理したかを確認できます。</p><p>これらのフォールトインジェクションルールをカスタマイズできることに注意してください。たとえば、（VirtualServicesを追加することで）一度に複数のサービスを失敗させる、<a href=https://istio.io/docs/reference/config/networking/virtual-service/#HTTPFaultInjection-Abort target=_blank>指定した割合のリクエストのみを失敗させる</a>、または特定のHTTPリクエストヘッダー（特定のWebブラウザーの挙動をテストするための <code>user-agent</code> など）のみ失敗させることなどが可能です。
エンドツーエンドのカオステストプロセスを自動化するために、独自のカオステストラッパーを作成することもできます（フォールトインジェクションルールの追加、クライアントの動作/状態の検査）。これを行うには、<a href=https://github.com/istio/client-go target=_blank>Istio Golangクライアントライブラリ</a>を使用して、クラスター上のVirtualServicesに対し，プログラム的なライフサイクルを回すことができます。</p><p>ソース：</p><ul><li><a href=https://istio.io/docs/tasks/traffic-management/fault-injection/ target=_blank>Istio Docs - タスク：フォールトインジェクション</a></li><li><a href=https://istio.io/docs/reference/config/networking/virtual-service/#HTTPFaultInjection target=_blank>Istio Docs - リファレンス：フォールトインジェクション</a></li><li><a href=https://static.sched.com/hosted_files/kccncchina2018english/18/ShengLiang-En.pdf target=_blank>Delivering Renewable Energy with Kubernetes（Kubecon China 2018）</a></li></ul></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>