<!doctype html><html><head><meta charset=utf-8><title>ローカリティロードバランシング&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=https://istiobyexample-ja.github.io/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="ローカリティロードバランシング"><meta property="og:description" content="大規模なグローバルアプリケーションを実行している場合、複数のリージョンでサービスを実行している可能性があります。同じサービスのレプリカが複数"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/locality-load-balancing/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-09T17:24:47+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="ローカリティロードバランシング"><meta name=twitter:description content="大規模なグローバルアプリケーションを実行している場合、複数のリージョンでサービスを実行している可能性があります。同じサービスのレプリカが複数"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> を和訳したものです</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>ローカリティロードバランシング</h1></section><div class=flex-body><article class=markdown-body><p>大規模なグローバルアプリケーションを実行している場合、複数のリージョンでサービスを実行している可能性があります。同じサービスのレプリカが複数ある場合は、レイテンシを最小限に抑えるために、クライアントリクエストを最も近いサーバーに転送することができます。また、1つのリージョンがダウンした場合にフェイルオーバーを処理し、トラフィックを最も近い利用可能なサービスに転送する方法が必要になる場合もあります。</p><p>Istioは、<strong>ローカリティロードバランシング</strong>と呼ばれる機能を使用して、リージョンのトラフィックを自動的に処理してくれます。方法を見てみましょう。</p><p><a target=_blank rel="noopener noreferrer" href=../images/loc-default.png><img class=img src=../images/loc-default.png alt=default></a></p><p>ここでは、<code>us-central</code> と <code>us-east</code> の2つの異なるクラウドリージョンで実行されている2つのKubernetesクラスターがあります。両クラスター内のServiceが互いに通信できるよう、<a href=https://github.com/GoogleCloudPlatform/istio-samples/tree/191859c03e73da7e98d451c967cefe24101d1933/multicluster-gke/single-control-plane#demo-multicluster-istio--single-control-plane target=_blank>シングルコントロールプレーン</a>によるIstioマルチクラスターがセットアップされており、そのIstioコントロールプレーンは <code>us-east</code> で稼働しています。</p><p>両方のクラスターを起動したときに、クラウドプロバイダーはリージョン固有の <code>failure-domain</code> ラベルをKubernetesノードに追加しました。:</p><pre><code>failure-domain.beta.kubernetes.io/region: us-central1
failure-domain.beta.kubernetes.io/zone: us-central1-b
</code></pre><p>Istioはこれらのローカリティラベルをリクエストに付与して、Istioがリクエストを最も近い利用可能なリージョンにリダイレクトできるようにします。</p><p>両方のクラスターは、<code>echo</code> と呼ばれる Istio-injected サービスを実行しています。これは、ポート <code>80</code> でアクセスが来たときにその内容を返します。中央クラスターは、<code>echo.default.svc.cluster.local:80</code> を毎秒呼び出す <code>loadgen</code> サービスも実行しています。</p><p>デフォルトでは、このKubernetes Serviceの動作は、両クラスタの2つの <code>echo</code> サーバー間でのラウンドロビン方式です。:</p><pre><code>$ 🌊 Hello World! - EAST
$ ✨ Hello World! - CENTRAL
$ 🌊 Hello World! - EAST
$ ✨ Hello World! - CENTRAL
</code></pre><p><a href=https://istio.io/docs/reference/config/networking/destination-rule/#OutlierDetection target=_blank>Outlier Detection</a>を設定したIstioのDestinationRuleリソースを <code>east</code> クラスタに追加することにより、ローカリティロードバランシングを有効にできます。:</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>DestinationRule<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>echo-outlier-detection<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>host</span><span class=p>:</span><span class=w> </span>echo.default.svc.cluster.local<span class=w>
</span><span class=w>  </span><span class=k>trafficPolicy</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>connectionPool</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>tcp</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>maxConnections</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span><span class=w>      </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>http2MaxRequests</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span><span class=w>        </span><span class=k>maxRequestsPerConnection</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>    </span><span class=k>outlierDetection</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>consecutiveErrors</span><span class=p>:</span><span class=w> </span><span class=m>7</span><span class=w>
</span><span class=w>      </span><span class=k>interval</span><span class=p>:</span><span class=w> </span>30s<span class=w>
</span><span class=w>      </span><span class=k>baseEjectionTime</span><span class=p>:</span><span class=w> </span>30s<span class=w>
</span></code></pre></div><p>これで、すべての <code>loadgen</code> リクエストは、<code>us-central</code> で実行されている最も近い <code>echo</code> のインスタンスにルーティングされます。:</p><pre><code>$ ✨ Hello World! - CENTRAL
$ ✨ Hello World! - CENTRAL
$ ✨ Hello World! - CENTRAL
</code></pre><p><a target=_blank rel="noopener noreferrer" href=../images/loc-locality.png><img class=img src=../images/loc-locality.png alt=locality></a></p><p><code>us-central</code> で実行されている <code>echo</code> デプロイメントを削除すると、Istioは <code>loadgen</code> リクエストを <code>us-east</code> で実行されている <code>echo</code> Podにリダイレクトします。:</p><pre><code>$ 🌊 Hello World! - EAST
$ 🌊 Hello World! - EAST
$ 🌊 Hello World! - EAST
</code></pre><p><a target=_blank rel="noopener noreferrer" href=../images/loc-failover.png><img class=img src=../images/loc-failover.png alt=failover></a></p><p>Istioのグローバルインストール設定で、メッシュ全体のトラフィックの割合に基づく負荷分散ルールを追加することもできます。:</p><pre><code>    localityLbSetting:
      distribute:
      - from: us-central1/*
        to:
          us-central1/*: 20
          us-east1/*: 80
</code></pre><p>これで、両方のクラスターで実行されているすべてのサービスが、<code>us-east</code> と <code>us-central</code> の間でリクエストを80/20共有します。 VirtualServicesは必要ありません。</p><pre><code>$ 🌊 Hello World! - EAST
$ 🌊 Hello World! - EAST
$ 🌊 Hello World! - EAST
$ 🌊 Hello World! - EAST
$ ✨ Hello World! - CENTRAL
</code></pre><p><a target=_blank rel="noopener noreferrer" href=../images/loc-splittraffic.png><img class=img src=../images/loc-splittraffic.png alt=split></a></p><p>Istioによるローカリティロードバランシングの詳細については、<a href=https://istio.io/docs/ops/configuration/traffic-management/locality-load-balancing/ target=_blank>Istio docs</a>をご覧ください。</p></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>