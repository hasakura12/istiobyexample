<!doctype html><html><head><meta charset=utf-8><title>gRPC&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=https://istiobyexample-ja.github.io/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="gRPC"><meta property="og:description" content="gRPC はサービス間通信のプロトコルで、HTTP/2 上で動作します。リソースベースの HTTP/1 上で動作する REST と異なり、gRPC は Service Definitions ベースです。データの通"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/grpc/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-05T04:43:47+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="gRPC"><meta name=twitter:description content="gRPC はサービス間通信のプロトコルで、HTTP/2 上で動作します。リソースベースの HTTP/1 上で動作する REST と異なり、gRPC は Service Definitions ベースです。データの通"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> の和訳です</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>gRPC</h1></section><div class=flex-body><article class=markdown-body><p><a href=https://grpc.io/ target=_blank>gRPC</a> はサービス間通信のプロトコルで、<a href=https://www.cncf.io/blog/2018/08/31/grpc-on-http-2-engineering-a-robust-high-performance-protocol/ target=_blank>HTTP/2</a> 上で動作します。<a href=https://ja.wikipedia.org/wiki/Representational_State_Transfer target=_blank>リソース</a>ベースの HTTP/1 上で動作する REST と異なり、gRPC は <a href=https://grpc.io/docs/guides/concepts/ target=_blank>Service Definitions</a> ベースです。データの通信や永続化のための小さなバイナリフォーマットへシリアライズすることができる <a href="https://developers.google.com/protocol-buffers?hl=ja" target=_blank>protocol buffers</a> (&ldquo;proto&rdquo;) と呼ばれるフォーマットで service definitions を指定します。</p><p>gRPC では <code>.proto</code> ファイルから <a href=https://grpc.io/docs/quickstart/ target=_blank>multiple programming languages</a> へのボイラープレートコードを生成することができます。このため、gRPC は 多言語での microservices のための理想的な選択となるでしょう。</p><p>gRPC は <a href=https://grpc.io/docs/guides/auth/ target=_blank>TLS</a> や <a href=https://grpc.io/blog/loadbalancing/ target=_blank>client-side load balancing</a> のようなユースケースをサポートしています。さらに gRPC のアーキテクチャに Istio を組み込むことはメトリクスの収集、トラフィックルールの追加、<a href=https://istio.io/blog/2018/istio-authorization/#rpc-level-authorization target=_blank>RPC-level authorization</a> といった利点があります。すべてのトラフィックタイプに同一の Istio API を使用できるため、トラフィックが HTTP, TCP, gRPC, そして データベースプロトコルの間で混在している場合でも、Istio は 便利な管理レイヤーを追加できます。</p><p><a href=https://istio.io/about/feature-stages/#traffic-management target=_blank>Istio</a> とそのデータプレーンプロキシーである <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_protocols/grpc#arch-overview-grpc target=_blank>Envoy</a> の両方が gRPC をサポートします。Istio を用いてどのように gRPC トラフィックを管理するか見てみましょう。</p><p><a target=_blank rel="noopener noreferrer" href=../images/grpc.png><img class=img src=../images/grpc.png alt=grpc></a></p><p>このように、<code>client</code> と <code>server</code> の2つの gRPC サービスがあります。<code>client</code> は RPC コールを <code>server</code> の <code>/SayHello</code> 関数へ2秒ごとに行います。</p><p>Istio を gRPC Kubernetes サービスへ追加するためには要件があります。Kubernetes の Service ports の <a href=https://istio.io/docs/setup/kubernetes/additional-setup/requirements/ target=_blank>labeling</a> です。server のポートは以下のようにラベル付けされます。</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>v1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Service<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>server<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>app</span><span class=p>:</span><span class=w> </span>server<span class=w>
</span><span class=w>  </span><span class=k>type</span><span class=p>:</span><span class=w> </span>ClusterIP<span class=w>
</span><span class=w>  </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>grpc<span class=w> </span><span class=c># important!</span><span class=w>
</span><span class=w>    </span><span class=k>protocol</span><span class=p>:</span><span class=w> </span>TCP<span class=w>
</span><span class=w>    </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></code></pre></div><p>アプリケーションをデプロイすると、<a href=https://www.kiali.io/ target=_blank>service graph</a> で client と server の間のトラフィックを見ることができます。</p><p><a target=_blank rel="noopener noreferrer" href=../images/grpc-kiali.png><img class=img src=../images/grpc-kiali.png alt=kiali></a></p><p>server の gRPC トラフィックメトリクスを Grafana でも見ることができます。</p><p><a target=_blank rel="noopener noreferrer" href=../images/grpc-server-healthy.png><img class=img src=../images/grpc-server-healthy.png alt></a></p><p>また、10秒遅延させる <a href=https://istio.io/docs/tasks/traffic-management/fault-injection/ target=_blank>fault</a> を <code>server</code> へ挿入するための Istio のトラフィックルールを適用できます。アプリケーションの回復性をテストするために、カオステストシナリオでこのルールを適用できるかもしれません。</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>server-fault<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- server<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>fault</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>delay</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>percentage</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span><span class=k>value</span><span class=p>:</span><span class=w> </span><span class=m>100.0</span><span class=w>
</span><span class=w>        </span><span class=k>fixedDelay</span><span class=p>:</span><span class=w> </span>10s<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>server<span class=w>
</span><span class=w>        </span><span class=k>subset</span><span class=p>:</span><span class=w> </span>v1<span class=w>
</span></code></pre></div><p>これにより client RPC にタイムアウト(<code>Outgoing Request Duration</code>)を起こします。</p><p><a target=_blank rel="noopener noreferrer" href=../images/grpc-grafana-client-fault-inject.png><img class=img src=../images/grpc-grafana-client-fault-inject.png alt></a></p><p>gRPC と Istio についてさらに学ぶために:</p><ul><li><a href=https://istio.io/docs/concepts/traffic-management/#traffic-routing-and-configuration target=_blank>Istio docs - Traffic Management</a></li><li><a href="https://cloud.google.com/solutions/using-istio-for-internal-load-balancing-of-grpc-services?hl=ja" target=_blank>ブログ - Istio を使用して内部 gRPC サービスを負荷分散する</a></li></ul></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>