<!doctype html><html><head><meta charset=utf-8><title>外部サービス&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=https://istiobyexample-ja.github.io/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="外部サービス"><meta property="og:description" content="Service Mesh はよく1つの環境 - 例えば、1つの Kubernetes クラスタ - 全体に及びます。また、その環境で接続されているすべてのサービスがメッシュの管理ドメインを形成"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/external-services/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-07T08:08:13+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="外部サービス"><meta name=twitter:description content="Service Mesh はよく1つの環境 - 例えば、1つの Kubernetes クラスタ - 全体に及びます。また、その環境で接続されているすべてのサービスがメッシュの管理ドメインを形成"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> の和訳です</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>外部サービス</h1></section><div class=flex-body><article class=markdown-body><p><a href=https://istio.io/docs/concepts/what-is-istio/#what-is-a-service-mesh target=_blank>Service Mesh</a> はよく1つの環境 - 例えば、1つの Kubernetes クラスタ - 全体に及びます。また、その環境で接続されているすべてのサービスがメッシュの管理ドメインを形成し、そこからメトリクスを見たりポリシーを設定できます。</p><p>しかし、クラスタの<strong>外部</strong>でもサービスを実行している場合や、外部 API に依存している場合はどうでしょうか。</p><p>心配は要りません。Istio は <a href=https://istio.io/docs/concepts/traffic-management/#service-entries target=_blank><code>ServiceEntry</code></a> と呼ばれるリソースを提供します。これにより、それがあなたの所有するサービスでなくても外部サービスを論理的にあなたのメッシュへ取り込むことができます。</p><p>外部ホスト名の ServiceEntry を作成すると、その外部サービスに到達するまでのメトリクスとトレースを表示できます。これらの外部サービスに<a href=../retry/>リトライロジック</a>などのトラフィックポリシーを設定することもできます。<code>ServiceEntries</code> を追加すると、Istio 管理ドメインの範囲が効果的に広がります。例を見てみましょう。</p><p><a target=_blank rel="noopener noreferrer" href=../images/ext-currency.png><img class=img src=../images/ext-currency.png alt="external currency service"></a></p><p>ここではユーザの居住地に基づいて商品の価格を変換する <code>currency</code> サービスを備えた、グローバルの EC サイトを動かしています。サードパーティの通過変換 API である <a href=https://www.ecb.europa.eu/stats/policy_and_exchange_rates/euro_reference_exchange_rates/html/index.en.html target=_blank>ヨーロッパ中央銀行</a> を使用して、リアルタイムの為替を提供しています。</p><p>メッシュ内のサービスからこの外部 API へのすべての読み出しに3秒のタイムアウトを設定します。これを行うには、2つの Istio リソースが必要です。</p><p>最初に、ヨーロッパの中央銀行ホスト名 <code>ecb.europa.eu</code> をメッシュに論理的に追加する <code>ServiceEntry</code> です。</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>ServiceEntry<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>currency-api<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- www.ecb.europa.eu<span class=w>
</span><span class=w>  </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=k>name</span><span class=p>:</span><span class=w> </span>http<span class=w>
</span><span class=w>    </span><span class=k>protocol</span><span class=p>:</span><span class=w> </span>HTTP<span class=w>
</span><span class=w>  </span>- <span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span><span class=w>    </span><span class=k>name</span><span class=p>:</span><span class=w> </span>https<span class=w>
</span><span class=w>    </span><span class=k>protocol</span><span class=p>:</span><span class=w> </span>HTTPS<span class=w>
</span></code></pre></div><p>次に、API 呼び出しのタイムアウトを設定するための <code>VirtualService</code> トラフィックルールです。</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>currency-timeout<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- www.ecb.europa.eu<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>timeout</span><span class=p>:</span><span class=w> </span>3s<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span><span class=k>host</span><span class=p>:</span><span class=w> </span>www.ecb.europa.eu<span class=w>
</span><span class=w>        </span><span class=k>weight</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></code></pre></div><p>通貨 API の ServiceEntry を作成すると、<a href=https://istio.io/docs/tasks/telemetry/kiali/ target=_blank>Kiali service graph</a> に自動的に <code>ecb.europa.eu</code> が表示されます。（そして，<strong>誰か</strong>がそれを呼んでいるのかすぐ知ることができます）</p><p><a target=_blank rel="noopener noreferrer" href=../images/ext-servicegraph.png><img class=img src=../images/ext-servicegraph.png alt="service graph"></a></p><p>また、この外部サービスのレスポンスコードやレイテンシなどのデータを表示する <a href=https://istio.io/docs/tasks/telemetry/metrics/using-istio-dashboard/ target=_blank>Grafana dashboard</a> もあります。</p><p><a target=_blank rel="noopener noreferrer" href=../images/ext-grafana.png><img class=img src=../images/ext-grafana.png alt=grafana></a></p><p><a href=https://istio.io/docs/tasks/traffic-management/egress/egress-control/#manage-traffic-to-external-services target=_blank>Istio ドキュメント</a> を参照して、外部サービスの管理とセキュリティについて学びましょう。</p></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>