<!doctype html><html><head><meta charset=utf-8><title>Prometheusの持ち込み&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=../istiobyexample/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="Prometheusの持ち込み"><meta property="og:description" content="Prometheusは、オープンソースの監視ツールです。デフォルトでは、PrometheusはIstioと一緒にインストールされるため、Gr"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/prometheus/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-05T18:15:37+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="Prometheusの持ち込み"><meta name=twitter:description content="Prometheusは、オープンソースの監視ツールです。デフォルトでは、PrometheusはIstioと一緒にインストールされるため、Gr"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> を和訳したものです</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>Prometheusの持ち込み</h1></section><div class=flex-body><article class=markdown-body><p><a href=https://prometheus.io/docs/introduction/overview/ target=_blank>Prometheus</a>は、オープンソースの監視ツールです。デフォルトでは、PrometheusはIstioと一緒にインストールされるため、GrafanaとKialiを使用して、IstioコントロールプレーンとEnvoyが挿入されたワークロードの両方のメトリクスを表示できます。</p><p>しかし、すでにクラスタでPrometheusを実行している場合、またはIstioのPrometheusインストールに追加のカスタマイズを行う場合（たとえば、Istioの<a href=https://prometheus.io/docs/alerting/notification_examples/#customizing-slack-notifications target=_blank>Slack通知</a>を追加する場合）はどうすればよいでしょうか？</p><p>心配要りません。 3つの簡単な手順で、ご自身で管理しているPrometheusをIstioに持ち込むことができます。</p><p>まず、<strong>Prometheus構成を更新します。</strong> Prometheusサーバー上の<a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config%e2%80%a6 target=_blank>スクレイプ構成モデル</a>に依存しており，そこでは <code>targets</code> が <code>/metrics</code> エンドポイントを表します。</p><p><a href=https://istio.io/docs/tasks/observability/metrics/querying-metrics/ target=_blank>各Istioコンポーネント</a>の targets を追加します。これらは、<a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config target=_blank>Kubernetes APIサーバーを介して</a>取得されます。たとえば、Istioの<a href=https://istio.io/docs/concepts/traffic-management/#pilot target=_blank>Pilot</a>コンポーネントの構成は次のとおりです。</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w>    </span>- <span class=k>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;pilot&#39;</span><span class=w>
</span><span class=w>      </span><span class=k>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- <span class=k>role</span><span class=p>:</span><span class=w> </span>endpoints<span class=w>
</span><span class=w>        </span><span class=k>namespaces</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span><span class=k>names</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span>- istio-system<span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=k>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- <span class=k>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span>__meta_kubernetes_service_name<span class=p>,</span><span class=w> </span>__meta_kubernetes_endpoint_port_name<span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=k>action</span><span class=p>:</span><span class=w> </span>keep<span class=w>
</span><span class=w>        </span><span class=k>regex</span><span class=p>:</span><span class=w> </span>istio-pilot;http-monitoring<span class=w>
</span></code></pre></div><p>完全な例は、<a href=https://github.com/askmeegs/istiobyexample/blob/888a7b5c573c9ba6bf2c0e046e44bf4f8d8d2506/content/blog/prometheus/configmap.yaml target=_blank>configmap.yaml</a>をご覧ください。</p><p>次に、<strong>PrometheusのDeploymentを更新して</strong>、Istioの証明書をPrometheusにマウントします。これにより、相互TLSが有効になっている場合でも、PrometheusはIstioワークロードをスクレイピングできます。これを行うには、<code>istio.default</code> SecretをPrometheusのDeployment.yamlに設定します。</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w>    </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>config-volume<span class=w>
</span><span class=w>        </span><span class=k>configMap</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>name</span><span class=p>:</span><span class=w> </span>prometheus<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>istio-certs<span class=w>
</span><span class=w>        </span><span class=k>secret</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>            </span><span class=k>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>420</span><span class=w>
</span><span class=w>            </span><span class=k>optional</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>            </span><span class=k>secretName</span><span class=p>:</span><span class=w> </span>istio.default<span class=w>
</span></code></pre></div><p>完全な例は、<a href=https://github.com/askmeegs/istiobyexample/blob/888a7b5c573c9ba6bf2c0e046e44bf4f8d8d2506/content/blog/prometheus/deployment.yaml target=_blank>deployment.yaml</a>をご覧ください。</p><p>この新しい構成でPrometheusをデプロイすると、DeploymentとServiceが別の <code>monitoring</code> ネームスペースで実行されます。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get service -n monitoring

NAME         TYPE           CLUSTER-IP   EXTERNAL-IP      PORT<span class=o>(</span>S<span class=o>)</span>          AGE
prometheus   LoadBalancer   10.0.3.155   &lt;IP&gt;             9090:32352/TCP   21m
</code></pre></div><p>最後に、カスタムのPrometheusアドレスを使用するようにIstioの構成を更新します。 <a href=https://istio.io/docs/reference/config/installation-options/#grafana-options target=_blank>Istioインストールオプション</a>を使用した <a href=https://istio.io/docs/setup/install/helm/ target=_blank><code>Helm テンプレート</code></a> の例を次に示します。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm template install/kubernetes/helm/istio --name istio --namespace istio-system <span class=se>\
</span><span class=se></span>--set prometheus.enabled<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span><span class=se></span>--set kiali.enabled<span class=o>=</span><span class=nb>true</span> --set kiali.createDemoSecret<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--set kiali.prometheusAddr<span class=o>=</span><span class=s2>&#34;http://prometheus.monitoring.svc.cluster.local:9090&#34;</span> <span class=se>\
</span><span class=se></span>--set <span class=s2>&#34;kiali.dashboard.jaegerURL=http://jaeger-query:16686&#34;</span> <span class=se>\
</span><span class=se></span>--set <span class=s2>&#34;kiali.dashboard.grafanaURL=http://grafana:3000&#34;</span> <span class=se>\
</span><span class=se></span>--set grafana.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--set grafana.datasources.datasources.datasources.url<span class=o>=</span><span class=s2>&#34;http://prometheus.monitoring.svc.cluster.local:9090&#34;</span>  &gt; istio.yaml
</code></pre></div><p>IstioとPrometheusの両方をインストールした後、Envoyが挿入されたワークロードをクラスターにデプロイすると、PrometheusがIstioターゲットを正常にスクレイピングしていることがわかります。</p><p><a target=_blank rel="noopener noreferrer" href=../images/prometheus.png><img class=img src=../images/prometheus.png alt></a></p><p>Grafanaはサービスレベルの指標を取得できます。</p><p><a target=_blank rel="noopener noreferrer" href=../images/prom-grafana.png><img class=img src=../images/prom-grafana.png alt></a></p><p>そして、Kialiはサービスグラフを表示できます。</p><p><a target=_blank rel="noopener noreferrer" href=../images/prom-kiali.png><img class=img src=../images/prom-kiali.png alt></a></p></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>