<!doctype html><html><head><meta charset=utf-8><title>データベーストラフィック&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=https://istiobyexample-ja.github.io/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="データベーストラフィック"><meta property="og:description" content="アプリケーションは複数の環境にまたがる場合が多く、データベースはその良い例です。レガシーまたはストレージの理由で、データベースをKubern"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/databases/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-09T17:43:39+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="データベーストラフィック"><meta name=twitter:description content="アプリケーションは複数の環境にまたがる場合が多く、データベースはその良い例です。レガシーまたはストレージの理由で、データベースをKubern"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> の和訳です</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>データベーストラフィック</h1></section><div class=flex-body><article class=markdown-body><p>アプリケーションは複数の環境にまたがる場合が多く、データベースはその良い例です。レガシーまたはストレージの理由で、データベースを<a href=https://cloud.google.com/blog/products/databases/to-run-or-not-to-run-a-database-on-kubernetes-what-to-consider target=_blank>Kubernetesの外</a>で稼働しているかもしれません。もしくはマネージドデータベースサービスを使用していることもあります。</p><p>しかし心配は要りません！ Istioサービスメッシュに外部データベースを追加できます。方法を見てみましょう。</p><p><a target=_blank rel="noopener noreferrer" href=../images/databases-diagram.png><img class=img src=../images/databases-diagram.png alt=diagram></a></p><p>ここでは、Istioが有効になっているKubernetesクラスター内で実行されている <code>plants</code> サービスがあります。<code>plants</code> は、<a href=https://firebase.google.com/docs/firestore target=_blank>Firestore</a>用のGolangクライアントライブラリを使用して、Google Cloudで実行されているFirestore NoSQLデータベースにインベントリを書き込みます。ログは次のようになります。:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>writing a new plant to Firestore...
✅success
</code></pre></div><p>Firestoreへの送信トラフィックを監視するとします。これを行うには、<a href=https://cloud.google.com/firestore/docs/reference/rpc/ target=_blank>Firestore API</a>のホスト名に対応するIstio <a href=https://istio.io/docs/reference/config/networking/service-entry/ target=_blank>ServiceEntry</a>を追加します。</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>ServiceEntry<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>firestore<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=s2>&#34;firestore.googleapis.com&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>https<span class=w>
</span><span class=w>    </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span><span class=w>    </span><span class=k>protocol</span><span class=p>:</span><span class=w> </span>HTTPS<span class=w>
</span><span class=w>  </span><span class=k>location</span><span class=p>:</span><span class=w> </span>MESH_EXTERNAL<span class=w>
</span><span class=w>  </span><span class=k>resolution</span><span class=p>:</span><span class=w> </span>DNS<span class=w>
</span></code></pre></div><p>ここから、Istioの<a href=https://istio.io/docs/tasks/observability/kiali/ target=_blank>サービスグラフ</a>にFirestoreが表示されます。</p><p><a target=_blank rel="noopener noreferrer" href=../images/databases-kiali-no-vs.png><img class=img src=../images/databases-kiali-no-vs.png alt=kiali></a></p><p><code>plants</code> のサイドカープロキシがFirestore TLSトラフィックを <a href=https://github.com/istio/istio/issues/14933 target=_blank>プレーンなTCPとして</a>受信しているため、トラフィックはTCPとして表示されることに注意してください。グラフの先頭は、Firestoreへのリクエストスループットの値をビット/秒で示しています。</p><p>ここで、データベースに接続できない場合の <code>plants</code> の動作をテストするとします。アプリケーションコードを変更せずに、Istioで行えます。</p><p>Istioは現在TCPフォールトインジェクションをサポートしていませんが、Firestore APIトラフィックを別の「ブラックホール」サービスに送信する<a href=https://istio.io/docs/reference/config/networking/virtual-service/#TCPRoute target=_blank>TCPトラフィックルール</a>を作成して、Firestoreへのクライアント接続を効果的に切断することができます。</p><p>これを行うには、クラスター内に小さな <code>echo</code> サービスをデプロイして、Firestoreへの全トラフィックを <code>echo</code> サービスに転送します。:</p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>fs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- firestore.googleapis.com<span class=w>
</span><span class=w>  </span><span class=k>tcp</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>echo<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></div><p>このIstio VirtualServiceをクラスターに適用すると、<code>plants</code> ログにエラーが報告されます。:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>writing a new plant to Firestore...
🚫 Failed adding plant: rpc error: <span class=nv>code</span> <span class=o>=</span> Unavailable <span class=nv>desc</span> <span class=o>=</span> all SubConns are in TransientFailure
</code></pre></div><p>そして、サービスグラフでは、<code>firestore</code> ノードに紫色の <code>VirtualService</code> アイコンがあることがわかります。これは、そのサービスに対してIstioトラフィックルールを適用したことを意味します。データベースへの全ての外部接続をリダイレクトしたため、やがて直近1分間のFirestoreのスループットは <code>0</code> になります。</p><p><a target=_blank rel="noopener noreferrer" href=../images/databases-kiali.png><img class=img src=../images/databases-kiali.png alt=kiali></a></p><p>Istioで、Redis、SQL、<a href=https://istio.io/blog/2018/egress-mongo/ target=_blank>MongoDB</a>など、クラスター内のデータベースのトラフィックを管理することもできます。詳細については、Istio docsをご覧ください。</p></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>