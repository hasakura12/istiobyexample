<!doctype html><html><head><meta charset=utf-8><title>複数のトラフィックルール&nbsp;&ndash;&nbsp;Istio By Example (ja)</title><link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel=stylesheet><link rel="shortcut icon" href=../images/spider-web.png><link rel=stylesheet href=https://istiobyexample-ja.github.io/istiobyexample/css/core.min.1ec2f555efc6ec0b36a9bbdf72319cf586f948899f24ab0ef5c93c82bbc7987b1eb704efe0b3a4dad22677058a40e6f6.css integrity=sha384-HsL1Ve/G7As2qbvfcjGc9Yb5SImfJKsO9ck8grvHmHsetwTv4LOk2tImdwWKQOb2><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light only"><meta name=supported-color-schemes content="light only"><meta property="og:title" content="複数のトラフィックルール"><meta property="og:description" content="Istioは、リダイレクトやトラフィック分割からミラーリングやリトライロジックまで、さまざまなトラフィック管理の使用例をサポートしています。"><meta property="og:type" content="article"><meta property="og:url" content="https://istiobyexample-ja.github.io/istiobyexample/multiple-traffic-rules/"><meta property="og:image" content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta property="article:published_time" content="2019-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-06T21:34:16+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://istiobyexample-ja.github.io/istiobyexample/images/opengraph.png"><meta name=twitter:title content="複数のトラフィックルール"><meta name=twitter:description content="Istioは、リダイレクトやトラフィック分割からミラーリングやリトライロジックまで、さまざまなトラフィック管理の使用例をサポートしています。"></head><body><div class="base-body max-width"><section id=header class="header max-body-width"><p><a class=home href=../><img class=site-logo src=../images/istio-logo.png alt>
<span class=site-name>Istio By Example</span></a></p><p>本サイトは <a href=https://istiobyexample.dev>Istio By Example</a> を和訳したものです</p></section><div id=content class="flex-body max-body-width"><section class=article-header><h1 class=article-title>複数のトラフィックルール</h1></section><div class=flex-body><article class=markdown-body><p>Istioは、<a href=https://istio.io/docs/reference/config/networking/virtual-service/#HTTPRewrite target=_blank>リダイレクト</a>や<a href=https://istio.io/docs/tasks/traffic-management/traffic-shifting/ target=_blank>トラフィック分割</a>から<a href=https://istio.io/docs/tasks/traffic-management/mirroring/ target=_blank>ミラーリング</a>や<a href=https://istio.io/docs/concepts/traffic-management/#retries target=_blank>リトライロジック</a>まで、さまざまな<a href=https://istio.io/docs/concepts/traffic-management/ target=_blank>トラフィック管理</a>の使用例をサポートしています。 Istio <a href=https://istio.io/docs/reference/config/networking/virtual-service/ target=_blank>VirtualService</a>を作成して、サービスのためにこれらのポリシーの1つを定義した場合、同じリソースにさらにトラフィック管理ルールを追加するのは簡単です。この例は、1つのKubernetesベースのサービスに複数のトラフィックルールを適用する方法を示しています。</p><p>たとえば、新聞社のWebサイトの<strong>frontend</strong>エンジニアリングチームにいるとします。ユーザー向けのfrontendサービスは、<strong>articles</strong>というバックエンドに依存しており、articlesのコンテンツとメタデータをJSONとして提供します。しかし、articlesチームはサービスを新しい言語でリファクタリングしており、新しい変更を頻繁に展開しています。これにより，古いarticleサービスの挙動に依存しているfrontendでは予期せぬエラーが発生するようになりました。さらに複雑なことに、以前は別の<strong>blog</strong>サービスで提供されていた新聞のブログが、articlesサービスに組み込まれてしまいました。現在、すべてのブログ投稿は <code>/beta/blog</code> パスで提供される記事です。</p><p>frontendに代わって articlesの動作を固定するために、articlesのIstioトラフィックポリシーを作成します。articlesに対するfrontendのトラフィック要件には、<code>/breaking-news</code> 記事に <code>no-cache</code> ヘッダーを付与する、<code>/blog</code> を <code>/beta/blog</code> に書き換える、すべてのリクエストで2秒のタイムアウトを適用するなどがあります。</p><p><a target=_blank rel="noopener noreferrer" href=../images/multiple-functionality.png><img class=img src=../images/multiple-functionality.png alt></a></p><p>この集約機能を取得するために、<code>/breaking-news</code> の<a href=../response-headers>レスポンスヘッダの変更</a>、<code>/blog</code> のURL書き換え、およびarticlesサービスへのデフォルトのフォールスルーの3つの <code>http</code> ルールを使用して、articlesに対して1つのVirtualServiceを作成します。 3つのルールすべてに2秒のタイムアウトがあります。</p><p><a target=_blank rel="noopener noreferrer" href=../images/multiple-vs.png><img class=img src=../images/multiple-vs.png alt></a></p><div class=highlight><pre class=chroma><code class=language-YAML data-lang=YAML><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1alpha3<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>articles-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- articles<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=k>match</span><span class=p>:</span><span class=w> </span><span class=c># RULE 1 - BREAKING NEWS</span><span class=w>
</span><span class=w>    </span>- <span class=k>uri</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>prefix</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/article/breaking-news&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>articles<span class=w>
</span><span class=w>      </span><span class=k>headers</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>response</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>          </span><span class=k>add</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>            </span><span class=k>no-cache</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>      </span><span class=k>timeout</span><span class=p>:</span><span class=w> </span>2s<span class=w>
</span><span class=w>  </span>- <span class=k>match</span><span class=p>:</span><span class=w> </span><span class=c># RULE 2 - BLOG URI REWRITE</span><span class=w>
</span><span class=w>    </span>- <span class=k>uri</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>prefix</span><span class=p>:</span><span class=w> </span>/blog<span class=w>
</span><span class=w>    </span><span class=k>rewrite</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span><span class=k>uri</span><span class=p>:</span><span class=w> </span>/beta/blog<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>articles<span class=w>
</span><span class=w>      </span><span class=k>timeout</span><span class=p>:</span><span class=w> </span>2s<span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w> </span><span class=c># RULE 3 / DEFAULT - TIMEOUT</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>articles<span class=w>
</span><span class=w>    </span><span class=k>timeout</span><span class=p>:</span><span class=w> </span>2s<span class=w>
</span><span class=w>    </span><span class=k>weight</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></code></pre></div><p>このVirtualServiceをクラスターに適用した後、 kubectl exec で frontend Pod に入り，articles サービスにアクセスすると、ルールが有効になっていることを確認できます。たとえば、<code>/breaking-news</code> 記事をリクエストすると、応答に <code>no-cache:true</code> ヘッダーが追加されます。:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl -v http://articles:80/article/breaking-news/2020/astrophysics-discovery

&lt; HTTP/1.1 <span class=m>200</span> OK
&lt; date: Wed, <span class=m>15</span> Jan <span class=m>2020</span> 22:10:52 GMT
...
&lt; no-cache: <span class=nb>true</span>
</code></pre></div><p><code>/blog</code> で始まるパスをリクエストすると、<code>/beta/blog</code> に書き直され、articlesは <code>/beta/blog</code> パスを提供することが分かります。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl http://articles:80/blog/2020/new-engineering-blog

<span class=o>{</span><span class=s2>&#34;id&#34;</span>:91385,<span class=s2>&#34;title&#34;</span>:<span class=s2>&#34;Welcome to the new News Blog!&#34;</span> ...
</code></pre></div><p>最後に、articlesサービスのアプリケーションコードに10秒のスリープ処理を追加すると、2秒のタイムアウトの動作を確認できます。:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl  http://articles:80/

upstream request timeout
</code></pre></div><p><a target=_blank rel="noopener noreferrer" href=../images/multiple-fault.png><img class=img src=../images/multiple-fault.png alt></a></p><p><strong>注</strong>：1つのVirtualServiceに複数のルールを追加すると、上から下まで<strong>順番に</strong><a href=https://istio.io/docs/concepts/traffic-management/#routing-rule-precedence target=_blank>ルールは評価</a>されます。したがって、articlesのVirtualServiceへ，全てのリクエストにHTTPステータスコード <code>404: Not Found</code> を返すような<a href=https://istio.io/docs/tasks/traffic-management/fault-injection/#injecting-an-http-abort-fault%e2%80%a6 target=_blank>fault injection</a>ルールを追加した場合、そのルールは他の3つをオーバーライドし、Articlesサービス全体を停止します。:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -v http://articles:80
...
* Connected to articles <span class=o>(</span>10.0.21.31<span class=o>)</span> port <span class=m>80</span>

&lt; HTTP/1.1 <span class=m>404</span> Not Found
</code></pre></div><p>VirtualServicesにはこのルールの優先順位があるため、複雑なIstioトラフィックポリシーを検証およびテストすることが重要です。上記で行ったように、「フォールスルー」またはデフォルトのルールを追加して、特定のホストに対するすべてのリクエストが確実にルーティングされるようにすることもお勧めします。</p></article></div><section id=footer class=footer><p>Made with ❤️ by <a href=https://twitter.com/askmeegs>Megan O'Keefe</a> | <a href=https://github.com/askmeegs/istiobyexample>Source</a> | <a href=https://github.com/cntrump/hugo-notepadium>Theme</a></p><p>Localized by <a href=https://github.com/istiobyexample-ja/istiobyexample>Istio by Example-ja Project</a></p></section></div></div></body></html>